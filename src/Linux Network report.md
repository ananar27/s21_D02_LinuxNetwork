
[image-id-1]: images/ipcalc1-1-1.png
[image-id-2]: images/ipcalc1-1-2.png
[image-id-3]: images/ipcalc1-1-2-1.png
[image-id-4]: images/ipcalc1-1-2-2.png
[image-id-5]: images/ipcalc1-1-3-1.png
[image-id-6]: images/ipcalc1-1-3-2.png
[image-id-7]: images/ipcalc1-1-3-3.png
[image-id-8]: images/ipcalc1-1-3-4.png
[image-id-9]: images/pip-range.png
[image-id-10]: images/ip-a-1.png
[image-id-11]: images/ip-a-2.png
[image-id-12]: images/part2-0.png
[image-id-13]: images/part2-0-1.png
[image-id-14]: images/part2-0-2.png
[image-id-15]: images/part2-0-3.png
[image-id-16]: images/part2-0-4.png
[image-id-17]: images/part2-1.png
[image-id-18]: images/part2-2-0.png
[image-id-19]: images/part2-2-1.png
[image-id-20]: images/part3-2.png
[image-id-21]: images/part4-1.png
[image-id-22]: images/part4-1-1.png
[image-id-23]: images/part4-2.png
[image-id-24]: images/part5-1.png
[image-id-25]: images/part5-2.png
[image-id-26]: images/scheme.png
[image-id-27]: images/part5-1-1.png
[image-id-28]: images/part5-1-2.png
[image-id-29]: images/part5-1-3.png
[image-id-30]: images/part5-1-4.png
[image-id-31]: images/part5-1-5.png
[image-id-32]: images/part5-1-6.png
[image-id-33]: images/part5-1-7.png
[image-id-34]: images/part5-1-8.png
[image-id-35]: images/part5-1-9.png
[image-id-36]: images/part5-1-10.png
[image-id-37]: images/part5-1-11.png
[image-id-38]: images/part5-1-12.png
[image-id-39]: images/part5-1-13.png
[image-id-40]: images/part5-1-14.png
[image-id-41]: images/part5-2-1.png
[image-id-42]: images/part5-2-2.png
[image-id-43]: images/part5-3-1.png
[image-id-44]: images/part5-3-2.png
[image-id-45]: images/part5-3-3.png
[image-id-46]: images/part5-3-4.png
[image-id-47]: images/part5-4-1.png
[image-id-48]: images/part5-4-2.png
[image-id-49]: images/part5-4-3.png
[image-id-50]: images/part5-5.png
[image-id-51]: images/part5-6.png
[image-id-52]: images/part6-1-1.png
[image-id-53]: images/part6-1-2.png
[image-id-54]: images/part6-1-3.png
[image-id-55]: images/part6-1-4.png
[image-id-56]: images/part6-1-5.png
[image-id-74]: images/part6-1-7.png
[image-id-75]: images/part6-4.png
[image-id-76]: images/part6-5.png
[image-id-57]: images/part7-1.png
[image-id-58]: images/part7-2.png
[image-id-59]: images/part7-3.png
[image-id-60]: images/part7-4.png
[image-id-61]: images/part7-5.png
[image-id-62]: images/part7-6.png
[image-id-63]: images/part7-7.png
[image-id-64]: images/part7-8.png
[image-id-65]: images/part7-9.png
[image-id-66]: images/part7-10.png
[image-id-67]: images/part7-11.png
[image-id-68]: images/part8-1.png
[image-id-69]: images/part8-2.png
[image-id-70]: images/part8-3.png
[image-id-71]: images/part8-4.png
[image-id-72]: images/part8-5.png
[image-id-73]: images/part8-6.png

# Report by RAFFORDG

## Part 1. Инструмент ipcalc

#### 1.1. Сети и маски
Для работы с инструментом ipclac устанавливаем его с помощью команды "sudo apt-get install ipcalc"
##### 1) Адрес сети:
Для определения адреса сети *192.167.38.54/13* вводим команду "ipcalc 192.167.38.54/13". Адресом данной сети является *192.160.0.0/13*
![image-id-1][]  *используем ipcalc*

##### 2) Работа с масками:
Перевод маски *255.255.255.0* в префиксную и двоичную запись:
CIDR: /24
Mask: 255.255.255.0
Binary mask: 11111111.11111111.11111111.00000000
![image-id-2][]  *используем ipcalc*

Перевод маски */15* в обычную и двоичную:
CIDR: /15
Mask: 255.254.0.0
Binary mask: 11111111.11111110.00000000.00000000
![image-id-3][]  *используем ipcalc*

Перевод маски *11111111.11111111.11111111.11110000* в обычную и префиксную:
Ipcalc не может работать с бинарным представлением маски подсети, только с префискным и обычным, поэтому для перевода в префиксную маску был использован подсчет единичек :)
CIDR: /28
Mask: 255.255.255.240
Binary mask: 11111111.11111111.11111111.11110000
![image-id-4][]

##### 3) Минимальный и максимальный хост в сети:
Значения максимального и минимального хоста сети *12.167.38.4* при масках: 
*/8*
HOSTMIN: 12.0.0.1
HOSTMAX: 12.255.255.254
![image-id-5][]


*11111111.11111111.00000000.00000000* 
HOSTMIN: 12.167.0.1
HOSTMAX: 12.167.255.254
![image-id-6][]


*255.255.254.0*
HOSTMIN: 12.167.38.1
HOSTMAX: 12.167.39.254
![image-id-7][]


*/4*
HOSTMIN: 0.0.0.1
HOSTMAX: 15.255.255.254
![image-id-8][]


#### 1.2. localhost
Можно обратиться к приложению с IP: 127.0.0.2, 127.1.0.1
Нельзя обратиться к приложению с IP: 194.34.23.100, 128.0.0.1

Частный IP-адрес (англ. private IP address), также называемый внутренним, внутрисетевым или локальным — IP-адрес, принадлежащий к специальному диапазону, не используемому в сети Интернет. Такие адреса предназначены для применения в локальных сетях, распределение таких адресов никем не контролируется. В связи с дефицитом свободных IP-адресов провайдеры всё чаще раздают своим абонентам именно внутрисетевые адреса, а не внешние, при этом они все выходят в интернет через один внешний IP (так называемый «белый IP»).

Частные диапазоны IP-адресов. Следующие диапазоны определены IANA как адреса, выделенные локальным сетям IPv4: 10.0.0.0 — 10.255.255.255 (маска подсети для бесклассовой (CIDR) адресации: 255.0.0.0 или /8) 100.64.0.0 — 100.127.255.255 (маска подсети 255.192.0.0 или /10) — Данная подсеть рекомендована согласно RFC 6598 для использования в качестве адресов для CGN (Carrier-Grade NAT). 172.16.0.0 — 172.31.255.255 (маска подсети: 255.240.0.0 или /12) 192.168.0.0 — 192.168.255.255 (маска подсети: 255.255.0.0 или /16) Также для петлевых интерфейсов (не используется для обмена между узлами сети) зарезервирован диапазон 127.0.0.0 — 127.255.255.255 (маска подсети: 255.0.0.0 или /8).

#### 1.3. Диапазоны и сегменты сетей
##### 1) Публичные и частные сети:
К диапазону частных сетей относят:
![image-id-9][]  *диапазон частных сетей*
Публичные сети: *134.43.0.2*, *172.0.2.1*, *192.172.0.1*, *172.68.0.2*, *192.169.168.1*
Частные сети: *10.0.0.45*, *10.10.10.10*, *172.20.250.4*, *172.16.255.255*, *192.168.4.2*

##### 2) Какие из перечисленных IP адресов шлюза возможны у сети *10.10.0.0/18*: *10.0.0.1*, *10.10.0.2*, *10.10.10.10*, *10.10.100.1*, *10.10.1.255*

            10.10.0.2
            10.10.10.10
            10.10.1.255


## Part 2. Статическая маршрутизация между двумя машинами

##### * Смотрим существующие сетевые интерфейсы с помощью команды `ip a`:
![image-id-10][]  *ws1*
![image-id-11][]  *ws2*

##### Опиши сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - *192.168.100.10*, маска */16*, ws2 - *172.24.116.8*, маска */12*

Для работы с сетевым интерфейсом внутренней сети необходимо выключить виртуальную машину и перейти в раздел Settings->Network->Adapter 2. Далее включаем функцию "Enable Network Adapter". В разделе "Attached to" выбираем Internal Network. Name: intnet.
![image-id-12][]  *ws1*
Повторяем для второй виртуальной машины
![image-id-13][]  *ws2*

Изменения в сетевые интерфейсы вносим с помощью mcedit или sudo nano /etc/netplan/00-installer-config.yaml. Вывод содержания измененного файла cat /etc/netplan/00-installer-config.yaml для каждой машины:
![image-id-14][]  *yaml configuration file*

##### Выполни команду `netplan apply` для перезапуска сервиса сети
![image-id-15][]  *netplan apply* 
![image-id-16][]  *ip a*

#### 2.1. Добавь статический маршрут вручную
Добавим статистический маршрут при помощи команды sudo ip r add и пропингуем ping -c соединение между машинами:
![image-id-17][]  *ping*

#### 2.2. Добавь статический маршрут с сохранением
Изменения вносим с помощью sudo nano /etc/netplan/00-installer-config.yaml. Добавим статический маршрут от одной машины до другой с помощью файла cat /etc/netplan/00-installer-config.yaml
![image-id-18][]  *изменения yaml configuration file*
Перезапустим сервер сети и пропингуем соединение между машинами:
![image-id-19][]  *ping*


## Part 3. Утилита **iperf3**

*В данном задании используются виртуальные машины ws1 и ws2 из Части 2*

#### 3.1. Скорость соединения
8 Mbps = 1 MB/s
100 MB/s = 8000 Kbps
1 Gbps = 1000 Mbps
#### 3.2. Утилита **iperf3**
Выполняем команды на ws11 - sudo iperf3 -s и на ws21 - sudo iperf3 -c 192.168.100.10
![image-id-20][]  *измеряем скорость соединения*

## Part 4. Сетевой экран.

#### 4.1. Утилита iptables:

* Создаем файлы `sudo vim /etc/firewall.sh`
![image-id-21][]  *конфигурация файла*

* Запуск файлов на обеих машинах командами `sudo chmod +x /etc/firewall.sh` и `sudo sh /etc/firewall.sh`
![image-id-22][]  *запуск скрипта*

#### 4.2. Утилита nmap:
Командой ping находим машину, которая не "пингуется", после чего утилитой nmap показываем, что хост машины запущен

Командой ping находим машину, которая не "пингуется", после чего утилитой nmap показываем, что хост машины запущен
![image-id-23][]  
* ws1 - OUTPUT для пакетов на ping-reply DROP - не работает т.е. пакеты отправляет, но не принимает.*
* ws2 - OUTPUT для пакетов на ping-reply ACCEPT - работает.


## Part 5. Статическая маршрутизация сети.

**В данном задании создайте 5 новых виртуальных машин.**

**Iso образ виртуальной машины Ubuntu Server 20.04 установить его в Virtual Box. Для ускорения процесса создания сети, можно клонировать виртуальные машины из образа машины, обновленной до последней версии как показано ниже:**

![image-id-24][] 
![image-id-25][]  *клонирование машин*
### 5.1. Настройка адресов машин:

* Сеть:
![image-id-26][] 

* Вносим изменения для каждой из машин в Oracle VM VirtualBox Manager: 
  * Для **r1**, Settings > Network > Adapter 1 (Internal Network, r1-ws11), Adapter 2 (Internal Network, r1-r2), Adapter 3 (NAT)

![image-id-27][]
![image-id-28][]
![image-id-29][]  *настройка соединений сети*

Для r2: Settings > Network > Adapter 1 (Internal Network, r1-r2), Adapter 2 (Internal Network, r2-ws21-ws22), Adapter 3 (NAT)

![image-id-30][]
![image-id-31][]
![image-id-32][]  *настройка соединений сети*

Для ws11, Settings > Network > Adapter 1 (Internal Network, r1-ws11), Adapter 2 (NAT)

![image-id-33][]  *настройка соединений сети*

Для ws21, ws22: Settings > Network > Adapter 1 (Internal Network, r2-ws21-ws22), Adapter 2 (NAT)

![image-id-34][]
![image-id-35][]  *настройка соединений сети*

Для каждой машины перезапустить сервис сети командой sudo netplan apply
2 роутера (r1, r2):
![image-id-36][]  *изменения yaml configuration file*

3 рабочие станции (ws11, ws22, ws21):
![image-id-37][]  *изменения yaml configuration file*

Для каждой машины выполнить команду reboot и ip -4 a:

2 роутера (r1, r2):
![image-id-38][]  *просмотр ip устройств системы ipv4*

3 рабочие станции (ws11, ws22, ws21):
![image-id-39][]  *просмотр ip устройств системы ipv4*

Пинг ws22 с ws21 и ping r1 с ws11:
![image-id-40][]  *просмотр ip устройств системы ipv4*


### 5.2. Включение переадресации IP-адресов:

* Для включения переадресации IP, на роутерах(r1, r2) выполнить команду : `sudo sysctl -w net.ipv4.ip_forward=1` (работает до перезагрузки)

![image-id-41][]  

Откройте на роутерах файл sudo nano /etc/sysctl.conf и добавьте в него следующую строку: net.ipv4.ip_forward = 1 (работает перманентно)

![image-id-42][]

### 5.3. Установка маршрута по-умолчанию:

* Настройка маршрута по-умолчанию (шлюз) для рабочих станций(ws11, ws22, ws21):

Вносим изменения для каждой из машин с помощью команды `sudo nano /etc/netplan/00-installer-config.yaml`

![image-id-43][]

Вызваем команду `ip r` и проверяем, добавился ли маршрут в таблицу маршрутизации:

![image-id-44][]

Пропингуем ws11 - r2; `sudo tcpdump -tn -i eth0`:

![image-id-45][]

Ошибка в Readme*, ниже показан вывод `sudo tcpdump -tn -i eth1`:

![image-id-46][]

В случае отсутствия правил маршрутизации в файлах конфигураций .yaml роутеров r1 и r2 невозможен трафик, переданный в локальные подсети этих роутеров, отправленный с устройств этих подсетей, в локальную подсеть соседнего роутера.

### 5.4. Добавление статических маршрутов:

Добавим в роутеры r1 и r2 статические маршруты в файле конфигураций.

![image-id-47][]

Вызовем команду `ip r`, чтобы отобразить таблицы с маршрутами на обоих роутерах.

![image-id-48][]

Запустим команды на ws11: `ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`

![image-id-49][]

IP-адрес и маска определяют адрес подключенной сети.
Маршрут вне системы выбирается на основе связанного с интерфейсом сетевого адреса. Выбор маршрута основывается на следующих элементах:
Порядок поиска группы маршрутов: прямые маршруты, маршруты в подсети, а затем маршруты по умолчанию.
Внутри группы выбирается маршрут с наиболее подходящей маской подсети.
Одинаково подходящие маршруты выбираются в зависимости от порядка их следования в списке или метода распределения загрузки.

При формировании пакета в заголовок передаётся известный изначально dst_ip.
dst_ip сопоставляется с IP-адресом сети, указанным в правилах (записях) ТМ в соответствии с приоритетом правила (является одним из параметров ТМ). Для этого netmask применяется (накладывается) к dst_ip с помощью побитового И AND. Затем, полученный резултьтат сложения dst_ip и netmask сетевого IP-адреса сетевого интерфейса роутера сопоставляется с IP-адресом сети. Если dst_ip соответствует IP-адресу сети, после применения к нему маски сети, то данное правило применяется для маршрутизации пакетов трафика данного dst_ip. Если не соответствует, то происходит сопоставление следующего по приоритету правила из ТМ. Если соответствующее правило в ТМ не найдено, то применяется правило (маршрут) по умолчанию default, созданное пользователем при (администратором сети) при настройке сетевого подключения через интерфейс пользователя. При этом в ТМ в колонках (столбцах) "Сетевой адрес Network Address" и "Маска подсети Netmask" автоматически присваивается значение: 0.0.0.0 В колонке "Интерфейс Interface" присваивается значение IP-адреса из поля "Основной шлюз gateway" UI. Таким образом, при сопоставлении любого dst_ip с сетевым IP-адресом: 0.0.0.0, после наложения на dst_ip маски сети 0.0.0.0, этот dst_ip "обнуляется" и соответствует сетевому адресу: 0.0.0.0 То есть, к нему применяется маршрут по умолчанию default.
После завершения М. становится известен IP-адрес назначения srs_ip заголовка 3 уровня (L3). Он соответствует IP-адресу сетевого интерфейса роутера, указанного в колонке Interface строки маршрута в ТМ, определённой при М.

Для адреса `10.10.0.0/[маска сети]` был выбран маршрут, отличный от `0.0.0.0/0`, потому что маска `/18` описывает маршрут к сети точнее, в отличие от маски `/0`.

### 5.5. Построение списка маршрутизаторов:

Запустим на r1 команду дампа: `tcpdump -tnv -i eth0` 
При помощи утилиты traceroute построим список маршрутизаторов на пути от ws11 до ws21: `traceroute [адрес сети]`

![image-id-50][]

Принцип работы traceroute:

Для определения промежуточных маршрутизаторов traceroute отправляет серию пакетов данных целевому узлу, при этом каждый раз увеличивая на 1 значение поля TTL («время жизни»). Это поле обычно указывает максимальное количество маршрутизаторов, которое может быть пройдено пакетом. Первый пакет отправляется с TTL, равным 1, и поэтому первый же маршрутизатор возвращает обратно сообщение ICMP, указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа (эти сведения выводятся на монитор компьютера). Затем traceroute повторяет отправку пакета, но уже с TTL, равным 2, что позволяет первому маршрутизатору пропустить пакет дальше.

Процесс повторяется до тех пор, пока при определённом значении TTL пакет не достигнет целевого узла. При получении ответа от этого узла процесс трассировки считается завершённым.

### 5.6. Использование протокола ICMP при маршрутизации:

Запустим на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды: `tcpdump -n -i eth0 icmp`
Пингуем с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды: `ping -c 1 10.30.0.111`

![image-id-51][]

## Part 6. Динамическая настройка IP с помощью DHCP:

**В данном задании используются виртуальные машины из Части 5.**

Для r2 настроить в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:
1. У казать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.
![image-id-52][]

2. В файле resolv.conf пропишем nameserver 8.8.8.8.
![image-id-53][]

3. Перезагрузим службу DHCP командой systemctl restart isc-dhcp-server. Машину ws21 перезагрузим при помощи reboot и через ip a проверим, что она получила адрес. Также пропинговать ws22 с ws21.
![image-id-54][]

4. Укажем MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо заменить текущий макадрес строки, с помощью добавления строк: macaddress: 10:10:10:10:10:BA, dhcp4: true.
![image-id-55][]
![image-id-56][]

![image-id-74][]

5. Роутер r1 настроим аналогично r2, но сделаем выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Проведем аналогичные тесты: sudo nano /etc/dhcp/dhcpd.conf для машины r1

![image-id-75][]


6. Перезагрузим службу DHCP командой `systemctl restart isc-dhcp-server`. Машину ws11 перезагружаем при помощи `reboot`
 Запросим с ws21 обновление ip адреса.
![image-id-76][]

Для отображения IP-адреса интерфейса eth0 можно использовать команду `ip addr show eth0`. Она покажет информацию о сетевом интерфейсе eth0, включая его IP-адрес. Если IP-адрес на интерфейсе не настроен, команда вернет пустой вывод для этого интерфейса.

## Part 7. **NAT**

**В данном задании используются виртуальные машины из Части 5**

1. В файле */etc/apache2/ports.conf* на ws22 и r1 изменим строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделаем сервер Apache2 общедоступным:

![image-id-57][]

2. Запустимвеб-сервер Apache командой `service apache2 start` на ws22 и r1:

![image-id-58][]

3. Добавим в фаервол на r2 следующие правила:
1) Удаление правил в таблице filter - `iptables -F`
2) Удаление правил в таблице "NAT" - `iptables -F -t nat`
3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`

![image-id-59][]
![image-id-60][]

Проверим соединение между ws22 и r1 командой `ping`
![image-id-61][]  *не пингуется*

4. Добавим в файл ещё одно правило:
Разрешим маршрутизацию всех пакетов протокола **ICMP**
![image-id-62][]  *добавление правила*

Проверм соединение между ws22 и r1 командой `ping`
![image-id-63][]

5. Включим **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)

`sudo iptables -A FORWARD -p tcp --dport 80 -j ACCEPT`
Данное правило iptables в Linux Ubuntu Server 20.04 позволяет пропустить через firewall трафик TCP-пакетов с адресом назначения на порту 80 через firewall.
Подробное описание параметров: 
`-A FORWARD` - добавление правила в цепочку FORWARD, отвечающую за пересылку пакетов между интерфейсами; 
`-p tcp` - указание протокола, в данном случае TCP; 
`--dport 80` - указание порта назначения, в данном случае 80 (стандартный порт HTTP); 
Данное правило может быть полезно, например, для разрешения доступа к веб-серверу, расположенному за межсетевым экраном, для пользователей внешней сети.

`sudo iptables -A FORWARD -p tcp --sport 80 -j ACCEPT`. Отличие данного правила от предыдущего заключается в проверке порта источника (source port) в TCP-пакете:
`--sport 80`: определяет порт источника (source port) в TCP-пакете. 
В данном случае, это порт 80, который обычно используется для HTTP-запросов. Предыдущее правило разрешает прохождение трафика на TCP-порту назначения (destination port), а данное правило разрешает прохождение трафика на TCP-порту источника (source port). Вместе они могут использоваться, например, для разрешения входящих и исходящих HTTP-запросов через межсетевой экран.

Включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0) с помощью правила настроек NAT для POSTROUTING цепочки в таблице NAT: `sudo iptables -t nat -A POSTROUTING -o eth0 -s 10.20.0.0/26 -j SNAT --to-source 10.100.0.12`. 
Описание параметров: 
`-t nat` - опция указывает таблицу nat, которая используется для настройки NAT. 
`-A POSTROUTING` - опция указывает, что правило должно быть добавлено в цепочку POSTROUTING таблицы nat. POSTROUTING цепочка применяет правила к пакетам, которые покидают сервер и отправляются во внешнюю сеть. 
`-o eth0` - опция указывает интерфейс, через который пакеты покидают сервер. В этом случае пакеты, которые покидают сервер, отправляются через интерфейс eth0. 
`-s 10.20.0.0/26` - опция указывает исходный IP-адрес для пакетов, которые будут обработаны правилом. В этом случае пакеты с IP-адресами в диапазоне 10.20.0.0 до 10.20.0.63 будут обработаны правилом. 
`-j SNAT` - опция указывает действие, которое будет выполнено, если пакет соответствует правилу. В этом случае действие SNAT используется для изменения исходного IP-адреса отправителя пакета.
`--to-source 10.100.0.12` - опция указывает IP-адрес, на который нужно изменить исходный адрес отправителя пакета. В этом случае исходный адрес отправителя пакета будет изменён на 10.100.0.12. 
Таким образом, данное правило изменяет исходный IP-адрес пакетов, проходящих через выходной интерфейс enp0s8, и имеющих исходный IP-адрес в диапазоне 10.20.0.0/26, на 10.100.0.12. Отличие от предыдущего правила (sudo iptables -A FORWARD -p tcp --dport 80 -j ACCEPT) заключается в том, что это правило настраивает NAT для изменения исходного IP-адреса отправителя пакетов, а не просто разрешает прохождение пакетов с определенным портом.

![image-id-64][]

Проверим соединение по TCP для SNAT, для этого с ws22 подключимся к серверу Apache на r1 командой: `sudo telnet 10.100.0.11 80`

![image-id-65][]

6. Включим **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети
`iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 8080 -j DNAT --to-destination 10.20.0.20:80` - правило iptables является правилом NAT (Network Address Translation) и определяет, что трафик, поступающий на сетевой интерфейс eth0 с портом назначения 8080 и протоколом TCP, должен быть перенаправлен на IP-адрес 10.20.0.20 с портом назначения 80 (по умолчанию для HTTP). 
Ключевое слово `DNAT` означает, что происходит изменение адреса назначения (Destination NAT). Описание параметров:
`-t nat` - устанавливает таблицу NAT, которая используется для изменения сетевых адресов. 
`-A PREROUTING` - добавляет правило в цепочку PREROUTING таблицы NAT, которая обрабатывает входящий трафик до того, как он пройдет маршрутизацию. 
`-i eth0`- задает интерфейс входящего трафика.
`-p tcp` - указывает протокол, которому принадлежит трафик. 
`--dport 8080` - указывает порт назначения трафика. 
`-j DNAT` - указывает, что нужно изменить адрес назначения пакета. 
`--to-destination 10.20.0.20:80` - указывает новый адрес и порт, на который нужно перенаправить трафик. 
Отличие от предыдущего правила заключается в том, что это правило применяется на входящий трафик (PREROUTING), тогда как предыдущее правило применяется на исходящий трафик (POSTROUTING). Также ключевое слово DNAT используется в этом правиле для изменения адреса назначения, в то время как в предыдущем правиле использовалось ключевое слово SNAT для изменения адреса источника.

![image-id-66][]

Проверим соединение по TCP для DNAT, для этого с r1 подключимся к серверу Apache на ws22 командой `telnet <адрес r2> 8080)`:

![image-id-67][]

## Part 8. Дополнительно. Знакомство с SSH Tunnels

** Запустим на r2 фаервол с правилами из Части 7

![image-id-68][]

В файле /etc/apache2/ports.conf изменим строку Listen 80 на Listen localhost:80
![image-id-69][]

Воспользуемся Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21

![image-id-70][]  *используем команду ssh -L 8080:localhost:80 r2*

Для проверки подключения перейдем во второй терминал и выполним команду: telnet 127.0.0.1 [локальный порт]

![image-id-71][]


Воспользуемся Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11

![image-id-72][]  *используем команду ssh -R 8080:localhost:22 r2*

Для проверки подключения перейдем во второй терминал и выполним команду: telnet 127.0.0.1 [локальный порт]

![image-id-73][]